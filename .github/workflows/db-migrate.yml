name: Database Migrations

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Migration target (master or tenant)'
        required: true
        default: 'tenant'
        type: choice
        options:
          - master
          - tenant
          - both

jobs:
  migrate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Run Master DB migrations
        if: ${{ inputs.target == 'master' || inputs.target == 'both' }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.MASTER_DB_PASSWORD }}
        run: |
          echo "Running Master DB migrations..."
          supabase db push --db-url "postgresql://postgres:${SUPABASE_DB_PASSWORD}@db.qvzmkaamzaqxpzbewjxe.supabase.co:5432/postgres" \
            --include-all

      - name: Run Tenant DB migrations
        if: ${{ inputs.target == 'tenant' || inputs.target == 'both' }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.TENANT_DB_PASSWORD }}
        run: |
          echo "Running Tenant DB migrations..."
          supabase db push --db-url "postgresql://postgres:${SUPABASE_DB_PASSWORD}@db.vzsohavtuotocgrfkfyd.supabase.co:5432/postgres" \
            --include-all

      - name: Verify migrations
        run: |
          echo "Migrations completed successfully"
